name: Continuous Deployment

on:
  push:
    branches: [ master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Deploy to Digital Ocean
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DROPLET_IP }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /var/www/4-final-camp
            
            # Pull latest changes
            git pull origin master
            
            # Update backend
            cd back-end
            npm install --production
            pm2 restart camp-backend
            
            # Update frontend
            cd ../front-end
            npm install
            CI=false npm run build
            
            # Restart nginx
            systemctl restart nginx
            
            # Check status
            pm2 status
            
            echo "‚úÖ Deployment completed successfully!"
      
      - name: Verify deployment
        run: |
          echo "Waiting for services to start..."
          sleep 10
          
          # Check if the site is responding
          response=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.DROPLET_IP }}/api/health)
          
          if [ $response -eq 200 ]; then
            echo "‚úÖ Deployment verified - API is responding"
          else
            echo "‚ùå Deployment verification failed - API returned status $response"
            exit 1
          fi
      
      - name: Notify deployment status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "üöÄ Deployment to production successful!"
            echo "Live at: http://${{ secrets.DROPLET_IP }}"
          else
            echo "‚ùå Deployment failed"
          fi
